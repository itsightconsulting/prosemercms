var pageNumber=0,pageSize=0;let arrayArchivos=[],arrayImagenes=[],rawTags="";var $btn=$("#btnGuardar");let modalImageSort=$("#sortImagenes").get(0),modalFileSort=$("#sortArchivos").get(0);$(function(){$("#sortArchivos").sortable(),$("#sortArchivos").disableSelection(),$("#sortImagenes").sortable(),$("#sortImagenes").disableSelection(),pageSetUp(),subirImagen(),subirArchivos(),instanciarTags(),CKEDITOR.replace("ckeditor",{height:"380px",startupFocus:!1}),validarRegistros(),$("#btnGuardar").click(function(){registro()}),$("#myModal").on("hidden.bs.modal",function(){reorganizarFileArrays()}),compare=function(d,f){return d.orden<f.orden?-1:d.orden>f.orden?1:0}});function registro(){if($("#frm_registro").valid())if(iframeBody=document.querySelectorAll(".cke_wysiwyg_frame")[0].contentDocument.querySelector("body"),0<iframeBody.textContent.length){var c=$("#btnGuardar");c.button("loading");var d={tituloPrincipal:$("#TituloPrincipal").val(),tituloLargo:$("#TituloLargo").val(),consultor:$("#Consultor").val(),responsableEntidad:$("#ResponsableEntidad").val(),alcance:iframeBody.innerHTML},f=parseInt($("#Mes").val())+1;f=10>f?"0"+f:f;var g=$("#Anio").val()+"/"+f+"/01";d.fechaEstudio=g,d.fkBeneficiario=$("#BeneficiarioId").val(),d.fkTipoEstudio=$("#TipoEstudioId").val(),d.flagResumen=$("#ResumenYoN").is(":checked"),$("#ResumenYoN").is(":checked")&&(d.resumen=iframeBody.textContent.substring(0,252).trim()+"..."),d.tags=$("#Tags").val(),$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"/gestion/estudio/agregar",dataType:"json",data:d,success:function(h,j){"success"==j&&("-9"==h?$.smallBox({content:"<i> Ha ocurrido un error interno en el sistema. Comunicarse con el administrador...</i>",timeout:4500,color:"alert"}):($.smallBox({}),addFiles(h,d.tags)))},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){}})}else $.smallBox({content:"<i> No se ha agregado <strong>el alcance del estudio.</strong></i>",color:"#8a6d3b",iconSmall:"fa fa-warning fa-2x fadeInRight animated",timeout:3500})}function readURL(c){if(c.files&&c.files[0]){var d=new FileReader;d.onload=function(f){$("#ImagenPortada").attr("src",f.target.result)},d.readAsDataURL(c.files[0])}}function subirImagen(){var c=window.URL||window.webkitURL;$("#UploadImage").change(function(){var d,f;(d=this.files[0])&&(f=new Image,f.onload=function(){readURL($("#UploadImage")[0])},f.onerror=function(){$("#UploadImage").val(""),$.smallBox({content:"<i> No se ha seleccionado una imagen v\xE1lida!</i>",color:"#8a6d3b",iconSmall:"fa fa-warning fa-2x fadeInRight animated",timeout:3500})},f.src=c.createObjectURL(d))})}function subirArchivos(){$("#ArchivosEstudio").change(function(){arrayArchivos=[],arrayImagenes=[],arraySizes=[];let c="",d="",f=0;var g=$("#ArchivosEstudio").get(0);if(file=this.files[0]){if(g=g.files,$("#FilesAmount").text(g.length),null!=g){var j=0,k=0;Array.from(g).forEach(l=>{l.type.match("application")?(l.sizeFormat=formatBytes(l.size),arrayArchivos.push(l),d+=`<li class="dd-item"><span class="label label-default font-sm"><span class="label label-warning font-sm">${++j}.</span> ${l.name}</span></li>`,f+=l.size):(arrayImagenes.push(l),c+=`<li class="dd-item"><span class="label label-success font-sm"><span class="label label-warning font-sm">${++k}.</span> ${l.name}</span></li>`,f+=l.size)}),modalFileSort.innerHTML=d,modalImageSort.innerHTML=c}$("#FileSize").text(formatBytes(f))}else modalFileSort.innerHTML="",modalImageSort.innerHTML=""})}function reorganizarFileArrays(){var c=[],d=[];Array.from(modalFileSort.children).forEach((f,g)=>{var h={nuevo:++g,antiguo:parseInt(f.textContent.split(".")[0])};c.push(h)}),Array.from(modalImageSort.children).forEach((f,g)=>{var h={nuevo:++g,antiguo:parseInt(f.textContent.split(".")[0])};d.push(h)}),arrayArchivos.forEach((f,g)=>{c.forEach(h=>{if(g+1===h.antiguo)return f.orden=h.nuevo,!1})}),arrayArchivos.sort(compare),arrayImagenes.forEach((f,g)=>{d.forEach(h=>{if(g+1===h.antiguo)return f.orden=h.nuevo,!1})}),arrayImagenes.sort(compare)}function addFiles(c,d){var f=[],g=$("#UploadImage").get(0),h=$("#ResumenImage").get(0),j=new FormData;null!=h.files[0]&&j.append("fileImagenResumen",h.files[0]),j.append("fileImagePortada",g.files[0]),j.append("ContenidoWebId",c);for(var k=0;k<arrayArchivos.length;++k)f=Array(arrayArchivos.length).fill(0),j.append("Documentos",arrayArchivos[k]),j.append("SizeList",arrayArchivos[k].sizeFormat);for(var k=0;k<arrayImagenes.length;++k)j.append("Imagenes",arrayImagenes[k]);var l=$("#AliasList").get(0);if(0<l.innerHTML.length)l=$("#AliasList").get(0).querySelectorAll("input"),Array.from(l).forEach((m,n)=>{f[n]=m.value});else for(var k=0;k<f.length;++k)f[k]="";j.append("Alias",f),$.ajax({type:"POST",url:"/gestion/estudio/cargarArchivos",data:j,contentType:!1,processData:!1,success:function(m,n){if("success"==n){$("#frm_registro")[0].reset();const o=document.querySelectorAll(".state-success");o.forEach(p=>p.classList.remove("state-success")),$("#ImagenPortada").attr("src","/img/upload-empty.png")}registrandoNuevasTags(d)},error:function(m){exception(m.status,m.responseJSON.error)},complete:function(){$btn.button("reset")}})}function ingresarAlias(){let c=modalFileSort.children,d="",f="";if(0<c.length){d=modalFileSort.innerHTML,Array.from(c).forEach(()=>{f+=`<input type='text' placeholder='Ingresa el alias'></input>`});var g=$("#FileList").get(0),h=$("#AliasList").get(0);g.innerHTML=d,h.innerHTML=f}}function instanciarTags(){var c=[];$.ajax({type:"GET",url:"/gestion/tag/obtenerListado",dataType:"json",success:function(d,f){"success"==f&&(d.forEach((g,h)=>{c[h]=g.nombre}),$("#Tags").tokenfield({autocomplete:{source:c,delay:100},showAutocompleteOnFocus:!1}))},error:function(d){exception(d.status,d.responseJSON.error)},complete:function(){rawTags=c.join()}})}function registrandoNuevasTags(c){c=c.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),rawTags=rawTags.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();var d=c.split(",");d.forEach(f=>{if(f=f.trim(),!rawTags.includes(f)){var h={};h.nombre=f.charAt(0).toUpperCase()+f.slice(1),h.tipo="es"==localStorage.getItem("idioma")?1:2,$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"/gestion/tag/agregar",dataType:"json",data:h,error:function(j){exception(j.status,j.responseJSON.error)},complete:function(){$("#Tags").get(0).innerHTML=""}})}}),window.location.href="/gestion/estudio"}function validarRegistros(){$("#frm_registro").validate({errorClass:errorClass,errorElement:errorElement,highlight:function(c){$(c).parent().removeClass("state-success").addClass("state-error"),$(c).removeClass("valid")},unhighlight:function(c){$(c).parent().removeClass("state-error").addClass("state-success"),$(c).addClass("valid")},ignore:".ignore",rules:{Tags:{required:!0,maxlength:100},TituloPrincipal:{required:!0,maxlength:$("#TituloPrincipal").prop("maxlength")},TituloLargo:{required:!0,maxlength:$("#TituloLargo").prop("maxlength")},Consultor:{required:!0,maxlength:$("#Consultor").prop("maxlength")},BeneficiarioId:{required:!0,digits:!0},ResponsableEntidad:{required:!0,maxlength:$("#ResponsableEntidad").prop("maxlength")},UploadImage:{required:!0},ResumenImage:{required:function(){return!!$("#ResumenYoN").is(":checked")}},ArchivosEstudio:{required:!0},TipoEstudioId:{required:!0,digits:!0},Anio:{required:!0,min:2e3,max:function(){return new Date().getFullYear()}},Mes:{required:!0,digits:!0}},messages:{Tags:{required:"Ingrese por lo menos un tag",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},TituloPrincipal:{required:"El campo es obligatorio",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},TituloLargo:{required:"El campo es obligatorio",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},Consultor:{required:"El campo es obligatorio",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},BeneficiarioId:{required:"El campo es obligatorio",digits:"Seleccione un beneficiario v\xE1lido"},ResponsableEntidad:{required:"El campo es obligatorio",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},UploadImage:{required:"La subida de la imagen es obligatoria"},ResumenImage:{required:"La subida de la imagen es obligatoria"},ArchivosEstudio:{required:"La subida de archivos es obligatoria"},TipoEstudioId:{required:"El campo es obligatorio",digits:"Seleccione un tipo de estudio v\xE1lido"},Anio:{required:"El a\xF1o es obligatorio",min:$.validator.format("Este campo debe tener un valor m\xEDnimo de {0}."),max:$.validator.format("Este campo debe tener un valor m\xE1ximo de {0}.")},Mes:{required:"El campo es obligatorio",digits:"Seleccione un periodo v\xE1lido"}},submitHandler:function(){registro()}})}