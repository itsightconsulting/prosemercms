var $table=$('#tblRegistros'),$tableFiles=$('#tblArchivos'),$index=$('#hIdQuienes'),pageNumber=0,pageSize=0;let arrayImagenes=[],modalImageSort=$('#sortImagenes').get(0);var iFrameBody='';$(function(){$('#sortImagenes').sortable(),$('#sortImagenes').disableSelection(),$(document).on('keypress',function(h){h.target.tagName.toLowerCase();h.keyCode===$.ui.keyCode.ENTER&&h.preventDefault()});var c=$('meta[name=\'_csrf\']').attr('content'),g=$('meta[name=\'_csrf_header\']').attr('content');$(document).ajaxSend(function(h,j){j.setRequestHeader(g,c)}),pageSetUp(),listarRegistros(),CKEDITOR.replace('ckeditor',{height:'380px',startupFocus:!1,on:{instanceReady:getBodyCKEditor}}),$('#btnGuardar').click(function(){registro()}),$('#btnCancelar').click(function(){$('#Username').removeAttr('disabled'),irListado($index)}),$('#UploadFiles').change(function(){subirArchivos(this)}),$('#UploadFile').change(function(){subirFileReemplazo(this)}),$('#btnNuevosArchivos').click(function(){addFiles()}),compare=function(j,k){return j.orden<k.orden?-1:j.orden>k.orden?1:0},$('#myModal').on('hidden.bs.modal',function(){$('#UploadFiles').val(''),modalImageSort.innerHTML=''}),$('#myModalVerificar').on('hidden.bs.modal',function(){reorganizarFileArrays()})});function listarRegistros(){$table.bootstrapTable('destroy'),$table.bootstrapTable({url:lang+'/gestion/quienes-somos/obtenerListado',pagination:!0,sidePagination:'client',pageSize:10,onLoadSuccess:()=>{},onLoadError:function(c){exception(c.status,c.responseJSON.error)}})}function registro(){if($('#frm_registro').valid())if(iframeBody=document.querySelectorAll('.cke_wysiwyg_frame')[0].contentDocument.querySelector('body'),0<iframeBody.textContent.length){var c=$('#btnGuardar');c.button('loading');var g={};g.id=$('#hIdQuienes').val(),g.contenido=iFrameBody.innerHTML,$.ajax({type:'POST',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:lang+'/gestion/quienes-somos/actualizar',dataType:'json',data:g,success:function(h,j){'success'==j&&('-9'==h?$.smallBox({content:'<i> El registro ha fallado debido a que el nombre de evento ya existe en el sistema...</i>',timeout:4500,color:'alert'}):$.smallBox({content:'El registro ha sido actualizado satisfactoriamente...'}))},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){$('#hIdQuienes').val(0),irListado($index),listarRegistros(),c.button('reset')}})}else $.smallBox({content:'<i> El <strong>contenido no debe actualizarse como vac\xEDo.</strong></i>',color:'#8a6d3b',iconSmall:'fa fa-warning fa-2x fadeInRight animated',timeout:3500})}function editar(c){var g={};g.id=c,$('#load_pace').show(),$.ajax({type:'GET',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:lang+'/gestion/quienes-somos/obtener',dataType:'json',data:g,success:function(h,j){'success'==j&&($('#hIdQuienes').val(h.id),$('#Menu').val(h.nombreMenu),iFrameBody.innerHTML=h.contenido)},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){irRegistro(),$('#load_pace').show()}})}function obtenerImagenes(c){$('#hIdQuienes').val(c),$('#UploadFiles').attr('accept','.jpg,.png'),$tableFiles.bootstrapTable('destroy'),$tableFiles.bootstrapTable({url:'/gestion/quienes-somos/obtenerImagenes',pagination:!1,sidePagination:'client',pageSize:10,queryParams:()=>{return{quienesSomosId:c}},onLoadSuccess:function(){},onLoadError:function(g){exception(g.status,g.responseJSON.error)}})}function obtenerImagenesDirecto(c){$tableFiles.bootstrapTable('destroy'),$tableFiles.bootstrapTable({url:'/gestion/contenido-imagen/obtenerListado',pagination:!1,sidePagination:'client',pageSize:10,queryParams:()=>{return{contenidoWebId:c}},onLoadSuccess:function(){},onLoadError:function(g){exception(g.status,g.responseJSON.error)}})}function subirArchivos(c){arrayImagenes=[],arraySizes=[],modalImageSort.innerHTML='';let g='',j=0;var k=$('#UploadFiles').get(0);if(file=c.files[0]){if(k=k.files,$('#FilesAmount').text(k.length),null!=k){var n=0;Array.from(k).forEach(o=>{arrayImagenes.push(o),g+=`<li class="dd-item"><span class="label label-success font-sm"><span class="label label-warning font-sm">${++n}.</span> ${o.name}</span></li>`,j+=o.size}),modalImageSort.innerHTML=g}$('#FileSize').text(formatBytes(j))}}function reorganizarFileArrays(){var c=[];Array.from(modalImageSort.children).forEach((g,h)=>{var j={nuevo:++h,antiguo:parseInt(g.textContent.split('.')[0])};c.push(j)}),arrayImagenes.forEach((g,h)=>{c.forEach(j=>{if(h+1===j.antiguo)return g.orden=j.nuevo,!1})}),arrayImagenes.sort(compare)}function visualizar(c){$('#Image').attr('src','/media/image/quienes-somos/historia'+c),$('#myModalImage').modal('show')}function reemplazar(c,g){$.smallBox({content:'\xBFEst\xE1s seguro de querer reemplazar el archivo o imagen? <p class=\'text-align-right\'><a href=\'javascript:confirmarReemplazo('+c+','+g+')\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:void(0);\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-bell swing animated',iconSmall:''})}function confirmarReemplazo(c,g){$('#hIdContenidoMedia').val(c),1==g?$.smallBox({content:'\xBFDesea <strong>agregar un alias</strong> al archivo? <p class=\'text-align-right\'><a href=\'javascript:agregarAlias();\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:continuarSinAlias();\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-question swing animated',iconSmall:''}):2==g&&$('#UploadFile')[0].click()}function baja(c,g,h){$.smallBox({content:'\xBFEst\xE1s seguro de querer eliminar el registro? <p class=\'text-align-right\'><a href=\'javascript:confirmarBaja('+c+','+g+','+h+');\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:void(0);\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-bell swing animated',iconSmall:''})}function confirmarBaja(c,g,h){var j='';1===g?j='contenido-archivo':2===g?j='contenido-imagen':void 0;$.ajax({type:'DELETE',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:'/gestion/'+j+'/eliminar/'+c,dataType:'json',success:function(k,l){'success'==l&&('-9'==k?$.smallBox({content:'<i> Ha ocurrido un error interno en el sistema. Comunicarse con el administrador...</i>',timeout:4500,color:'alert'}):($.smallBox({content:'El registro se ha eliminado satisfactoriamente.'}),document.querySelector('#tblArchivos tbody tr[data-index=\''+h+'\']').remove()))},error:function(k){exception(k.status,k.responseJSON.error)},complete:function(){}})}function subirFileReemplazo(c){var g=window.URL||window.webkitURL,h,j;(h=c.files[0])&&(j=new Image,j.onload=function(){var k=$('#UploadFile').get(0).files[0],l=new FormData;l.append('image',k),l.append('id',$('#hIdContenidoMedia').val()),$.ajax({type:'PUT',url:'/gestion/contenido-imagen/actualizar',data:l,contentType:!1,processData:!1,success:function(m,n){'success'==n&&('-99'==m?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):'-1'==m?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):$.smallBox({content:'<i> La imagen se reemplazo satisfactoriamente...</i>',iconSmall:'fa fa-refresh fa-2x'}))},error:function(m){exception(m.status,m.responseJSON.error)},complete:function(m){obtenerImagenesDirecto(parseInt(m.responseJSON)),$('#UploadFile').val('')}})},j.onerror=function(){bootbox.alert('No se ha seleccionado una imagen v\xE1lida: <strong>'+h.type+'')},j.src=g.createObjectURL(h))}function addFiles(){$('#btnNuevosArchivos').button('loading');var g=new FormData,h=$('#hIdQuienes').val();g.append('QuienesId',h);for(var j=0;j<arrayImagenes.length;++j)g.append('Imagenes',arrayImagenes[j]);$.ajax({type:'POST',url:'/gestion/quienes-somos/cargarArchivos',data:g,contentType:!1,processData:!1,success:function(k,l){'success'==l&&($('#UploadFiles').val(''),$.smallBox({content:'Se agregaron las im\xE1genes satisfactoriamente...'}))},error:function(k){exception(k.status,k.responseJSON.error)},complete:function(){obtenerImagenes(h),$('#btnNuevosArchivos').button('reset')}})}function getBodyCKEditor(){iFrameBody=document.querySelectorAll('.cke_wysiwyg_frame')[0].contentDocument.querySelector('body')}function linkFormatter(c,g){return String('<a class="editable editable-click" href="#" onclick="javascript:editar('+g.id+')" title="Editar">'+g.nombreMenu+'</a>',c)}function Opciones(){var j='';return j=`<a href='#' title='Inhabilitado para este contenido'><i style='color:gray;' class='glyphicon glyphicon-picture'></i></a> &nbsp`,j}function opcionesArchivos(c,g,h){var j='';return j=`<a href='#' onclick='javascript:visualizar("${g.rutaMediaWeb}");' title='Visualizar imagen'><i class='glyphicon glyphicon-eye-open'></i></a> &nbsp<a href='#' onclick='javascript:reemplazar(${g.id}, 2);' title='Reemplazar'><i class='glyphicon glyphicon-cloud-upload'></i></a> &nbsp<a href='#' onclick='javascript:baja(${g.id}, 2, ${h});' title='Eliminar'><i class='glyphicon glyphicon-trash text-danger'></i></a> &nbsp`,j}