var pageNumber=0,pageSize=0;let arrayArchivos=[],arrayImagenes=[],rawTags="";var $btn=$("#btnGuardar"),$table=$("#tblEstudios");let modalImageSort=$("#sortImagenes").get(0),modalFileSort=$("#sortArchivos").get(0);$(function(){function c(f){var g=$("#Beneficiarios").text();$.SmartMessageBox({title:"Alertas Prosemer",content:"Ahora seleccione un beneficiario:",buttons:"[Continuar]",input:"select",options:g},function(h,j){$("#btnOcultoModal").click(),$("#Beneficiario").val(j),buscarPorTipoEstudio(f,j,0)});try{$("#Msg2").css("background-color","#41542b")}catch(h){}}$("#sortArchivos").sortable(),$("#sortArchivos").disableSelection(),$("#sortImagenes").sortable(),$("#sortImagenes").disableSelection(),pageSetUp(),subirArchivos(),instanciarTags(),CKEDITOR.replace("ckeditor",{height:"380px",startupFocus:!1}),validarRegistros(),setFechaActual(),$("#btnGuardar").click(function(){registro()}),$("#myModal").on("hidden.bs.modal",function(){reorganizarFileArrays()}),$("#btnRelacionar").click(function(f){var g=$("#TipoEstudios").text();$.SmartMessageBox({title:"Alertas Prosemer",content:"Seleccione un tipo de estudio:",buttons:"[Seguir]",input:"select",options:g},function(h,j){c(j)}),f.preventDefault()}),$("#btnBuscaEstudio").click(function(f){f.preventDefault(),$estudio=$("#NombreEstudio").val(),2<$estudio.length?buscarPorTipoEstudio(0,$("#Beneficiario").val(),$estudio):$.smallBox({content:"<i> Se necesita una valor m\xEDnimo de 3 car\xE1cteres para<br> <strong>realizar la b\xFAsqueda.</strong></i>",color:"#8a6d3b",iconSmall:"fa fa-warning fa-2x fadeInRight animated",timeout:3500})}),compare=function(g,h){return g.orden<h.orden?-1:g.orden>h.orden?1:0}});function registro(){if($("#frm_registro").valid())if(iframeBody=document.querySelectorAll(".cke_wysiwyg_frame")[0].contentDocument.querySelector("body"),0<iframeBody.textContent.length){var c=$("#btnGuardar");c.button("loading");var f={tituloPrincipal:$("#TituloPrincipal").val(),tituloLargo:$("#TituloLargo").val(),tituloEstudioReferencia:$("#EstudioSeleccionado").val(),descripcion:iframeBody.innerHTML},g=$("#FechaCapacitacion").val().split("-");f.fechaCapacitacion=new Date(g[0],+g[1]-1,g[2]),f.flagResumen=$("#ResumenYoN").is(":checked"),$("#ResumenYoN").is(":checked")&&(f.resumen=iframeBody.textContent.substring(0,252).trim()+"..."),f.tags=$("#Tags").val(),0<$("#hIdEstudio").val().length&&(f.fkEstudio=$("#hIdEstudio").val()),0<$("#hIdBeneficiario").val().length&&(f.fkBeneficiario=$("#hIdBeneficiario").val()),$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"/gestion/capacitacion/agregar",dataType:"json",data:f,success:function(h,j){"success"==j&&("-9"==h?$.smallBox({content:"<i> Ha ocurrido un error interno en el sistema. Comunicarse con el administrador...</i>",timeout:4500,color:"alert"}):($.smallBox({}),addFiles(h,f.tags)))},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){}})}else $.smallBox({content:"<i> No se ha agregado <strong>la descripci\xF3n de la capacitacion.</strong></i>",color:"#8a6d3b",iconSmall:"fa fa-warning fa-2x fadeInRight animated",timeout:3500})}function subirArchivos(){$("#ArchivosCapacitacion").change(function(){arrayArchivos=[],arrayImagenes=[],arraySizes=[];let c="",f="",g=0;var h=$("#ArchivosCapacitacion").get(0);if(file=this.files[0]){if(h=h.files,$("#FilesAmount").text(h.length),null!=h){var k=0,l=0;Array.from(h).forEach(m=>{m.type.match("application")?(m.sizeFormat=formatBytes(m.size),arrayArchivos.push(m),f+=`<li class="dd-item"><span class="label label-default font-sm"><span class="label label-warning font-sm">${++k}.</span> ${m.name}</span></li>`,g+=m.size):(arrayImagenes.push(m),c+=`<li class="dd-item"><span class="label label-success font-sm"><span class="label label-warning font-sm">${++l}.</span> ${m.name}</span></li>`,g+=m.size)}),modalFileSort.innerHTML=f,modalImageSort.innerHTML=c}$("#FileSize").text(formatBytes(g))}else arrayArchivos=[],arrayImagenes=[],modalFileSort.innerHTML="",modalImageSort.innerHTML=""})}function reorganizarFileArrays(){var c=[],f=[];Array.from(modalFileSort.children).forEach((g,h)=>{var j={nuevo:++h,antiguo:parseInt(g.textContent.split(".")[0])};c.push(j)}),Array.from(modalImageSort.children).forEach((g,h)=>{var j={nuevo:++h,antiguo:parseInt(g.textContent.split(".")[0])};f.push(j)}),arrayArchivos.forEach((g,h)=>{c.forEach(j=>{if(h+1===j.antiguo)return g.orden=j.nuevo,!1})}),arrayArchivos.sort(compare),arrayImagenes.forEach((g,h)=>{f.forEach(j=>{if(h+1===j.antiguo)return g.orden=j.nuevo,!1})}),arrayImagenes.sort(compare)}function addFiles(c,f){var g=[],h=$("#ResumenImage").get(0),j=new FormData;j.append("ContenidoWebId",c),null!=h.files[0]&&j.append("fileImagenResumen",h.files[0]);for(var k=0;k<arrayArchivos.length;++k)g=Array(arrayArchivos.length).fill(0),j.append("Documentos",arrayArchivos[k]),j.append("SizeList",arrayArchivos[k].sizeFormat);for(var k=0;k<arrayImagenes.length;++k)j.append("Imagenes",arrayImagenes[k]);var l=$("#AliasList").get(0);if(0<l.innerHTML.length)l=$("#AliasList").get(0).querySelectorAll("input"),Array.from(l).forEach((m,n)=>{g[n]=m.value});else for(var k=0;k<g.length;++k)g[k]="";j.append("Alias",g),$.ajax({type:"POST",url:"/gestion/capacitacion/cargarArchivos",data:j,contentType:!1,processData:!1,success:function(m,n){if("success"==n){$("#frm_registro")[0].reset();const o=document.querySelectorAll(".state-success");o.forEach(p=>p.classList.remove("state-success"))}registrandoNuevasTags(f)},error:function(m){exception(m.status,m.responseJSON.error)},complete:function(){$btn.button("reset")}})}function ingresarAlias(){let c=modalFileSort.children,f="",g="";if(0<c.length){f=modalFileSort.innerHTML,Array.from(c).forEach(()=>{g+=`<input type='text' placeholder='Ingresa el alias'></input>`});var h=$("#FileList").get(0),j=$("#AliasList").get(0);h.innerHTML=f,j.innerHTML=g}}function buscarPorTipoEstudio(c,f,g){$table.bootstrapTable("destroy"),$table.bootstrapTable({url:"/gestion/estudio/obtenerListado/top/"+c+"/"+f+"/"+g,pagination:!1,sidePagination:"client",pageSize:10,onLoadSuccess:function(){},onLoadError:function(h){exception(h.status,h.responseJSON.error)}})}function linkFormatter(c,f){return String("<a class=\"editable editable-click\" href=\"#\" onclick=\"javascript:elegirEstudio("+f.id+","+f.beneficiario.id+",'"+f.tituloPrincipal+"')\" title=\"Seleccionar\">"+f.tituloPrincipal+"</a>",c)}function elegirEstudio(c,f,g){$("#EstudioSeleccionado").val(g),$("#myModalEstudio").modal("hide"),$("#hIdEstudio").val(c),$("#hIdBeneficiario").val(f),$.smallBox({content:"Ha seleccionado el estudio: <br/><strong>"+g+"</strong>",color:"rgb(91, 175, 69)",timeout:5e3,icon:"fa fa-hand-o-up swing animated",iconSmall:""})}function instanciarTags(){var c=[];$.ajax({type:"GET",url:"/gestion/tag/obtenerListado",dataType:"json",success:function(f,g){"success"==g&&(f.forEach((h,j)=>{c[j]=h.nombre}),$("#Tags").tokenfield({autocomplete:{source:c,delay:100},showAutocompleteOnFocus:!1}))},error:function(f){exception(f.status,f.responseJSON.error)},complete:function(){rawTags=c.join()}})}function registrandoNuevasTags(c){c=c.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),rawTags=rawTags.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();var f=c.split(",");f.forEach(g=>{if(g=g.trim(),!rawTags.includes(g)){var j={};j.nombre=g.charAt(0).toUpperCase()+g.slice(1),j.tipo="es"==localStorage.getItem("idioma")?1:2,$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"/gestion/tag/agregar",dataType:"json",data:j,error:function(k){exception(k.status,k.responseJSON.error)},complete:function(){$("#Tags").get(0).innerHTML=""}})}}),window.location.href="/gestion/capacitacion"}function setFechaActual(){$("#FechaCapacitacion").val((f=>`${f.getFullYear()}-${("00"+(f.getMonth()+1)).slice(-2)}-${("00"+f.getDate()).slice(-2)}`)(new Date))}function validarRegistros(){$("#frm_registro").validate({errorClass:errorClass,errorElement:errorElement,highlight:function(c){$(c).parent().removeClass("state-success").addClass("state-error"),$(c).removeClass("valid")},unhighlight:function(c){$(c).parent().removeClass("state-error").addClass("state-success"),$(c).addClass("valid")},ignore:".ignore",rules:{Tags:{required:!0,maxlength:100},TituloPrincipal:{required:!0,maxlength:$("#TituloPrincipal").prop("maxlength")},TituloLargo:{required:!0,maxlength:$("#TituloLargo").prop("maxlength")},ResumenImage:{required:function(){return!!$("#ResumenYoN").is(":checked")}},ArchivosCapacitacion:{required:!0},FechaCapacitacion:{required:!0},hIdEstudio:{required:!0,number:!0,min:1}},messages:{Tags:{required:"Ingrese por lo menos un tag",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},TituloPrincipal:{required:"El campo es obligatorio",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},TituloLargo:{required:"El campo es obligatorio",maxlength:$.validator.format("Este campo debe de tener como m\xE1ximo {0} caracteres.")},ResumenImage:{required:"La subida de la imagen es obligatoria"},ArchivosCapacitacion:{required:"La subida de archivos es obligatoria"},FechaLogro:{required:"El campo es obligatorio",dateISO:"Seleccione una fecha v\xE1lida"},hIdEstudio:{required:"Se requiere asociar la capacitaci\xF3n a un estudio",number:"No ha seleccionado un estudio v\xE1lido",min:"No ha seleccionado un estudio v\xE1lido"}},submitHandler:function(){registro()}})}