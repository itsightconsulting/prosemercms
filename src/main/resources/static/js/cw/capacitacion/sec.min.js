var $table=$('#tblRegistros'),$tableFiles=$('#tblArchivos'),$index=$('#hIdCapacitacion'),pageNumber=0,pageSize=0;let arrayArchivos=[],arrayImagenes=[];var errorClass='invalid',errorElement='em',rawTags='',alias='';let modalFileSort=$('#sortArchivos').get(0),modalImageSort=$('#sortImagenes').get(0);var iFrameBody='';$(function(){$('#sortArchivos').sortable(),$('#sortArchivos').disableSelection(),$('#sortImagenes').sortable(),$('#sortImagenes').disableSelection(),$(document).on('keypress',function(h){h.target.tagName.toLowerCase();h.keyCode===$.ui.keyCode.ENTER&&h.preventDefault()});var c=$('meta[name=\'_csrf\']').attr('content'),g=$('meta[name=\'_csrf_header\']').attr('content');$(document).ajaxSend(function(h,j){j.setRequestHeader(g,c)}),pageSetUp(),listarRegistros(),instanciarTags(),CKEDITOR.replace('ckeditor',{height:'380px',startupFocus:!1,on:{instanceReady:getBodyCKEditor}}),validarRegistros(),validarBusqueda(),$('#btnNuevo').click(function(){window.location.href='/gestion/capacitacion/nuevo'}),$('#btnGuardar').click(function(){registro()}),compare=function(j,k){return j.orden<k.orden?-1:j.orden>k.orden?1:0},$('#btnCancelar').click(function(){$('#Username').removeAttr('disabled'),irListado($index)}),$('#btnFiltrar').click(function(){listarRegistros()}),$('#btnNuevosArchivos').click(function(){addFiles()}),$('#UploadFile').change(function(){subirFileReemplazo(this)}),$('#UploadOnlyFile').change(function(){subirOnlyFileReemplazo(this)}),$('#UploadFiles').change(function(){subirArchivos(this)}),$('#UploadResumenImage').change(function(){subirResumenImage(this)}),$('#myModalVerificar').on('hidden.bs.modal',function(){reorganizarFileArrays()}),$('#myModal').on('hidden.bs.modal',function(){$('#UploadFiles').val(''),modalFileSort.innerHTML='',modalImageSort.innerHTML='',$('#AliasList').get(0).innerHTML=''})});function subirArchivos(c){arrayArchivos=[],arrayImagenes=[],arraySizes=[],rawInputs='',modalFileSort.innerHTML='',modalImageSort.innerHTML='',$AliasList=$('#AliasList').get(0),$AliasList.innerHTML='';let g='',h='',j=0;var k=$('#UploadFiles').get(0);if(file=c.files[0]){if(k=k.files,$('#FilesAmount').text(k.length),null!=k){var m=0,n=0;Array.from(k).forEach(o=>{o.type.match('application')?(o.sizeFormat=formatBytes(o.size),arrayArchivos.push(o),h+=`<li class="dd-item"><span class="label label-default font-sm"><span class="label label-warning font-sm">${++m}.</span> ${o.name}</span></li>`,j+=o.size,rawInputs+=`<input type='text' placeholder='Ingresa el alias'></input>`):(arrayImagenes.push(o),g+=`<li class="dd-item"><span class="label label-success font-sm"><span class="label label-warning font-sm">${++n}.</span> ${o.name}</span></li>`,j+=o.size)}),modalImageSort.innerHTML=g,modalFileSort.innerHTML=h,$AliasList.innerHTML=rawInputs}$('#FileSize').text(formatBytes(j))}else modalFileSort.innerHTML=''}function listarRegistros(){if($('#frm_busqueda').valid()){$table.bootstrapTable('destroy');var g=$('#txtFiltro').val(),h=$('#Estado').val(),j=$('#Beneficiario').val();(null==g||''==g)&&(g='0'),null==h&&(h='-1'),(null==j||''==j)&&(j='0'),$table.bootstrapTable({url:lang+'/gestion/capacitacion/obtenerListado/'+g+'/'+h+'/'+j,pagination:!0,sidePagination:'client',pageSize:10,onLoadSuccess:()=>{},onLoadError:function(k){exception(k.status,k.responseJSON.error)}})}}function registro(){if($('#frm_registro').valid())if(iframeBody=document.querySelectorAll('.cke_wysiwyg_frame')[0].contentDocument.querySelector('body'),0<iframeBody.textContent.length){var c=$('#btnGuardar');c.button('loading');var g=$('#Tags').val(),h={};h.id=$('#hIdCapacitacion').val(),h.tituloPrincipal=$('#TituloPrincipal').val(),h.tituloLargo=$('#TituloLargo').val(),h.descripcion=iFrameBody.innerHTML;var j=$('#FechaCapacitacion').val().split('-');h.fechaCapacitacion=new Date(j[0],+j[1]-1,j[2]),h.flagResumen=!1,h.resumen=iFrameBody.textContent.substring(0,232).trim()+'...',h.tags=g,$.ajax({type:'POST',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:lang+'/gestion/capacitacion/agregar',dataType:'json',data:h,success:function(k,l){'success'==l&&('-9'==k?$.smallBox({content:'<i> El registro ha fallado debido a que el nombre de capacitacion ya existe en el sistema...</i>',timeout:4500,color:'alert'}):($.smallBox({content:'El registro ha sido actualizado satisfactoriamente...'}),registrandoNuevasTags(h.tags)))},error:function(k){exception(k.status,k.responseJSON.error)},complete:function(){$('#hIdCapacitacion').val(0),limpiarBusqueda(),irListado($index),listarRegistros(),c.button('reset')}})}else $.smallBox({content:'<i> La <strong> descripcion de la capacitaci\xF3n no puede actualizarse como vac\xEDo.</strong></i>',color:'#8a6d3b',iconSmall:'fa fa-warning fa-2x fadeInRight animated',timeout:3500})}function editar(c,g){var h={};h.id=c,$('#load_pace').show(),$.ajax({type:'GET',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:lang+'/gestion/capacitacion/obtener',dataType:'json',data:h,success:function(j,k){'success'==k&&($('#hIdCapacitacion').val(j.id),$('#hIdBeneficiario').val(g),$('#hIdEstudio').val(j.estudio.id),$('#EstudioSeleccionado').val(j.estudio.tituloPrincipal),$('#TituloPrincipal').val(j.tituloPrincipal),$('#TituloLargo').val(j.tituloLargo),iFrameBody.innerHTML=j.descripcion,$('#Consultor').val(j.consultor),$('#ResponsableEntidad').val(j.responsableEntidad),$('#FechaCapacitacion').val(j.fechaCapacitacion),$('#Tags').tokenfield('setTokens',j.tags))},error:function(j){exception(j.status,j.responseJSON.error)},complete:function(){limpiarBusqueda(),irRegistro(),$('#load_pace').show()}})}function desactivar(c){$.SmartMessageBox({title:'<i class=\'fa fa-bullhorn\'></i> Notificaciones Prosemer',content:'<br/>\xBFQuieres activar o desactivar el registro?',buttons:'[No][Si]'},function(g){if('Si'===g){var h={};h.id=c,$('#load_pace').show(),$.ajax({type:'PUT',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:'/gestion/capacitacion/desactivar',dataType:'json',data:h,success:function(j,k){'success'==k&&$.smallBox({content:'<i class=\'fa fa-child fa-2x\'></i> <i>Actualizaci\xF3n exitosa...!</i>'})},error:function(j){exception(j.status,j.responseJSON.error)},complete:function(){limpiarBusqueda(),listarRegistros()}})}else;})}function getBodyCKEditor(){iFrameBody=document.querySelectorAll('.cke_wysiwyg_frame')[0].contentDocument.querySelector('body')}function linkFormatter(c,g){return String('<a class="editable editable-click" href="#" onclick="javascript:editar('+g.id+','+g.beneficiario.id+')" title="Editar">'+g.tituloPrincipal+'</a>',c)}function Opciones(c,g){return opciones=`<a href='#' onclick='javascript:desactivar(${g.id});' title='Actualizar status'><i class='glyphicon glyphicon-refresh'></i></a> &nbsp<a href='#' onclick='javascript:obtenerArchivos(${g.id});' title='Gestionar Archivos' data-toggle='modal' data-target='#myModal'><i class='glyphicon glyphicon-file'></i></a> &nbsp<a href='#' onclick='javascript:obtenerImagenes(${g.id});' title='Gestionar Galeria' data-toggle='modal' data-target='#myModal'><i class='glyphicon glyphicon-picture'></i></a> &nbsp<a href='#' onclick='javascript:reemplazarResumenImage(${g.id});' title='Reemplazar Imagen para Resumen'><i class='glyphicon glyphicon-cloud-upload'></i></a> &nbsp`,opciones}function isActived(c,g){return g.flagActivo?'<span class="label label-success">Activo</span>':'<span class="label label-danger">Inactivo</span>'}function instanciarTags(){var c=[];$.ajax({type:'GET',url:'/gestion/tag/obtenerListado',dataType:'json',success:function(g,h){'success'==h&&(g.forEach((j,k)=>{c[k]=j.nombre}),$('#Tags').tokenfield({autocomplete:{source:c,delay:100},showAutocompleteOnFocus:!1}))},error:function(g){exception(g.status,g.responseJSON.error)},complete:function(){rawTags=c.join()}})}function registrandoNuevasTags(c){c=c.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(),rawTags=rawTags.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();var g=c.split(',');g.forEach(h=>{if(h=h.trim(),!rawTags.includes(h)){var k={};k.nombre=h.charAt(0).toUpperCase()+h.slice(1),params.tipo='es'==localStorage.getItem('idioma')?1:2,$.ajax({type:'POST',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:'/gestion/tag/agregar',dataType:'json',data:k,error:function(l){exception(l.status,l.responseJSON.error)},complete:function(){$('#Tags').get(0).innerHTML=''}})}}),''==$('#Tags').get(0).innerHTML&&($('#Tags').tokenfield('destroy'),instanciarTags())}function obtenerArchivos(c){$('#hIdCapacitacion').val(c),$('#UploadFiles').attr('accept','.pdf,.docx,.doc,.docx,.xls,.xlsx,.ppt,.pptx'),$tableFiles.bootstrapTable('destroy'),$tableFiles.bootstrapTable({url:'/gestion/capacitacion/obtenerArchivos',pagination:!1,sidePagination:'client',pageSize:10,queryParams:()=>{return{capacitacionId:c}},onLoadSuccess:function(){},onLoadError:function(g){exception(g.status,g.responseJSON.error)}})}function obtenerImagenes(c){$('#hIdCapacitacion').val(c),$('#UploadFiles').attr('accept','.jpg,.png'),$tableFiles.bootstrapTable('destroy'),$tableFiles.bootstrapTable({url:'/gestion/capacitacion/obtenerImagenes',pagination:!1,sidePagination:'client',pageSize:10,queryParams:()=>{return{capacitacionId:c}},onLoadSuccess:function(){},onLoadError:function(g){exception(g.status,g.responseJSON.error)}})}function obtenerImagenesDirecto(c){$tableFiles.bootstrapTable('destroy'),$tableFiles.bootstrapTable({url:'/gestion/contenido-imagen/obtenerListado',pagination:!1,sidePagination:'client',pageSize:10,queryParams:()=>{return{contenidoWebId:c}},onLoadSuccess:function(){},onLoadError:function(g){exception(g.status,g.responseJSON.error)}})}function obtenerArchivosDirecto(c){$tableFiles.bootstrapTable('destroy'),$tableFiles.bootstrapTable({url:'/gestion/contenido-archivo/obtenerListado',pagination:!1,sidePagination:'client',pageSize:10,queryParams:()=>{return{contenidoWebId:c}},onLoadSuccess:function(){},onLoadError:function(g){exception(g.status,g.responseJSON.error)}})}function opcionesArchivos(c,g,h){var j='';return j=null==g.peso?`<a href='#' onclick='javascript:visualizar("${g.rutaMediaWeb}");' title='Visualizar imagen'><i class='glyphicon glyphicon-eye-open'></i></a> &nbsp<a href='#' onclick='javascript:reemplazar(${g.id}, 2);' title='Reemplazar'><i class='glyphicon glyphicon-cloud-upload'></i></a> &nbsp<a href='#' onclick='javascript:baja(${g.id}, 2, ${h});' title='Eliminar'><i class='glyphicon glyphicon-trash text-danger'></i></a> &nbsp`:`<a href='#' onclick='javascript:descargar("${g.rutaMediaWeb}");' title='Descargar'><i class='glyphicon glyphicon-cloud-download'></i></a> &nbsp<a href='#' onclick='javascript:reemplazar(${g.id}, 1);' title='Reemplazar'><i class='glyphicon glyphicon-cloud-upload'></i></a> &nbsp<a href='#' onclick='javascript:baja(${g.id}, 1, ${h});' title='Eliminar'><i class='glyphicon glyphicon-trash text-danger'></i></a> &nbsp`,j}function visualizar(c){$('#Image').attr('src','/media/image/capacitacion'+c),$('#myModalImage').modal('show')}function descargar(c){window.location.href='/media/file/capacitacion/gt/0'+c,$.smallBox({content:'La descarga ha iniciado...',iconSmall:'fa fa-cloud fa-2x',color:'#296191'})}function reemplazarResumenImage(c){$.smallBox({content:'\xBFEst\xE1s seguro de querer reemplazar la imagen para el resumen? <p class=\'text-align-right\'><a href=\'javascript:confirmarReemplazoResumenImage('+c+')\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:void(0);\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-paper-plane swing animated',iconSmall:''})}function reemplazar(c,g){$.smallBox({content:'\xBFEst\xE1s seguro de querer reemplazar el archivo o imagen? <p class=\'text-align-right\'><a href=\'javascript:confirmarReemplazo('+c+','+g+')\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:void(0);\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-bell swing animated',iconSmall:''})}function baja(c,g,h){$.smallBox({content:'\xBFEst\xE1s seguro de querer eliminar el registro? <p class=\'text-align-right\'><a href=\'javascript:confirmarBaja('+c+','+g+','+h+');\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:void(0);\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-bell swing animated',iconSmall:''})}function confirmarBaja(c,g,h){var j='';1===g?j='contenido-archivo':2===g?j='contenido-imagen':void 0;$.ajax({type:'DELETE',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:'/gestion/'+j+'/eliminar/'+c,dataType:'json',success:function(k,l){'success'==l&&('-9'==k?$.smallBox({content:'<i> Ha ocurrido un error interno en el sistema. Comunicarse con el administrador...</i>',timeout:4500,color:'alert'}):($.smallBox({content:'El registro se ha eliminado satisfactoriamente.'}),document.querySelector('#tblArchivos tbody tr[data-index=\''+h+'\']').remove()))},error:function(k){exception(k.status,k.responseJSON.error)},complete:function(){}})}function confirmarReemplazo(c,g){$('#hIdContenidoMedia').val(c),1==g?$.smallBox({content:'\xBFDesea <strong>agregar un alias</strong> al archivo? <p class=\'text-align-right\'><a href=\'javascript:agregarAlias();\' class=\'btn btn-primary btn-sm\'>Si</a> <a href=\'javascript:continuarSinAlias();\' class=\'btn btn-danger btn-sm\'>No</a></p>',color:'#296191',timeout:1e4,icon:'fa fa-question swing animated',iconSmall:''}):2==g&&$('#UploadFile')[0].click()}function confirmarReemplazoResumenImage(c){$('#hIdCapacitacion').val(c),$('#UploadResumenImage')[0].click()}function agregarAlias(){bootbox.prompt('Ingrese el alias:',function(c){c&&(alias=c,$('#UploadOnlyFile')[0].click())})}function continuarSinAlias(){$('#UploadOnlyFile')[0].click()}function subirFileReemplazo(c){var g=window.URL||window.webkitURL,h,j;(h=c.files[0])&&(j=new Image,j.onload=function(){var k=$('#UploadFile').get(0).files[0],l=new FormData;l.append('image',k),l.append('id',$('#hIdContenidoMedia').val()),$.ajax({type:'PUT',url:'/gestion/contenido-imagen/actualizar',data:l,contentType:!1,processData:!1,success:function(m,n){'success'==n&&('-99'==m?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):'-1'==m?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):$.smallBox({content:'<i> La imagen se reemplazo satisfactoriamente...</i>',iconSmall:'fa fa-refresh fa-2x'}))},error:function(m){exception(m.status,m.responseJSON.error)},complete:function(m){obtenerImagenesDirecto(parseInt(m.responseJSON)),$('#UploadFile').val('')}})},j.onerror=function(){bootbox.alert('No se ha seleccionado una imagen v\xE1lida: <strong>'+h.type+'')},j.src=g.createObjectURL(h))}function subirResumenImage(c){var g=window.URL||window.webkitURL,h,j;(h=c.files[0])&&(j=new Image,j.onload=function(){var k=$('#UploadResumenImage').get(0).files[0],l=new FormData;l.append('file',k),l.append('id',$('#hIdCapacitacion').val()),$.ajax({type:'PUT',url:'/gestion/capacitacion/imagen/resumen',data:l,contentType:!1,processData:!1,success:function(m,n){'success'==n&&('-99'==m?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):'-1'==m?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):$.smallBox({content:'<i> La imagen se reemplazo satisfactoriamente...</i>',iconSmall:'fa fa-refresh fa-2x'}))},error:function(m){exception(m.status,m.responseJSON.error)},complete:function(){$('#UploadResumenImage').val('')}})},j.onerror=function(){bootbox.alert('No se ha seleccionado una imagen v\xE1lida: <strong>'+h.type+'')},j.src=g.createObjectURL(h))}function subirOnlyFileReemplazo(c){var g;if(g=c.files[0]){var h=new FormData;h.append('file',g),h.append('id',$('#hIdContenidoMedia').val()),h.append('peso',formatBytes(g.size)),0<alias.length&&h.append('alias',alias),$.ajax({type:'PUT',url:'/gestion/contenido-archivo/actualizar',data:h,contentType:!1,processData:!1,success:function(j,k){'success'==k&&('-99'==j?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):'-1'==j?bootbox.alert('El archivo no ha podido ser guardado debido. Para mayor informaci\xF3n comunicarse con el administrador.'):$.smallBox({content:'<i> El archivo se reemplazo satisfactoriamente...</i>',iconSmall:'fa fa-refresh fa-2x'}))},error:function(j){exception(j.status,j.responseJSON.error)},complete:function(j){obtenerArchivosDirecto(parseInt(j.responseJSON)),$('#UploadOnlyFile').val(''),alias=''}})}}function reorganizarFileArrays(){var c=[],g=[];Array.from(modalFileSort.children).forEach((h,j)=>{var k={nuevo:++j,antiguo:parseInt(h.textContent.split('.')[0])};c.push(k)}),Array.from(modalImageSort.children).forEach((h,j)=>{var k={nuevo:++j,antiguo:parseInt(h.textContent.split('.')[0])};g.push(k)}),arrayArchivos.forEach((h,j)=>{c.forEach(k=>{if(j+1===k.antiguo)return h.orden=k.nuevo,!1})}),arrayArchivos.sort(compare),arrayImagenes.forEach((h,j)=>{g.forEach(k=>{if(j+1===k.antiguo)return h.orden=k.nuevo,!1})}),arrayImagenes.sort(compare)}function addFiles(){$('#btnNuevosArchivos').button('loading');var c=[],g=new FormData,h=$('#hIdCapacitacion').val();g.append('CapacitacionId',h);for(var j=0;j<arrayArchivos.length;++j)c=Array(arrayArchivos.length).fill(0),g.append('Documentos',arrayArchivos[j]),g.append('SizeList',arrayArchivos[j].sizeFormat);for(var j=0;j<arrayImagenes.length;++j)g.append('Imagenes',arrayImagenes[j]);var k=$('#AliasList').get(0);if(0<k.innerHTML.length)k=$('#AliasList').get(0).querySelectorAll('input'),Array.from(k).forEach((l,m)=>{c[m]=l.value});else for(var j=0;j<c.length;++j)c[j]='';g.append('Alias',c),$.ajax({type:'POST',url:'/gestion/capacitacion/cargarArchivos/v2',data:g,contentType:!1,processData:!1,success:function(l,m){'success'==m&&($('#UploadFiles').val(''),$.smallBox({content:'Se agregaron los registros satisfactoriamente...'}))},error:function(l){exception(l.status,l.responseJSON.error)},complete:function(){0<c.length?obtenerArchivos(h):obtenerImagenes(h),$('#btnNuevosArchivos').button('reset')}})}function validarRegistros(){$('#frm_registro').validate({errorClass:errorClass,errorElement:errorElement,highlight:function(c){$(c).parent().removeClass('state-success').addClass('state-error'),$(c).removeClass('valid')},unhighlight:function(c){$(c).parent().removeClass('state-error').addClass('state-success'),$(c).addClass('valid')},ignore:'.ignore',rules:{TituloLargo:{required:!0,maxlength:$('#TituloLargo').prop('maxlength')},TituloPrincipal:{required:!0,maxlength:$('#TituloPrincipal').prop('maxlength')},FechaCapacitacion:{required:!0}},messages:{TituloLargo:{required:'El campo es obligatorio',maxlength:$.validator.format('Este campo debe de tener como m\xE1ximo {0} caracteres.')},TituloPrincipal:{required:'El campo es obligatorio',maxlength:$.validator.format('Este campo debe de tener como m\xE1ximo {0} caracteres.')},FechaCapacitacion:{required:'Seleccione una fecha v\xE1lida'}},submitHandler:function(){registro()}})}function validarBusqueda(){$('#frm_busqueda').validate({ignore:'.ignore',errorClass:'my-error-class',validClass:'my-valid-class',rules:{Filtro:{required:!0},Tipo:{digits:!0}},messages:{Filtro:{required:'Debe seleccionar un tipo de formato'},Tipo:{digits:'Debe seleccionar un tipo'}},submitHandler:function(){}})}function limpiarBusqueda(){$('#txtFiltro').val(''),$('#Estado').val('-1')}