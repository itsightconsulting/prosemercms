var $table=$('#tblRegistros'),$index=$('#hIdLogro'),pageNumber=0,pageSize=0,errorClass='invalid',errorElement='em',iFrameBody='';$(function(){$(document).on('keypress',function(g){g.target.tagName.toLowerCase();g.keyCode===$.ui.keyCode.ENTER&&g.preventDefault()});var c=$('meta[name=\'_csrf\']').attr('content'),f=$('meta[name=\'_csrf_header\']').attr('content');$(document).ajaxSend(function(g,h){h.setRequestHeader(f,c)}),pageSetUp(),listarRegistros(),CKEDITOR.replace('ckeditor',{height:'380px',startupFocus:!1,on:{instanceReady:getBodyCKEditor}}),validarRegistros(),validarBusqueda(),$('#btnNuevo').click(function(){window.location.href='/gestion/logro/nuevo'}),$('#btnGuardar').click(function(){registro()}),compare=function(h,i){return h.orden<i.orden?-1:h.orden>i.orden?1:0},$('#btnCancelar').click(function(){$('#Username').removeAttr('disabled'),irListado($index)}),$('#btnFiltrar').click(function(){listarRegistros()})});function listarRegistros(){if($('#frm_busqueda').valid()){$table.bootstrapTable('destroy');var f=$('#txtFiltro').val(),g=$('#Estado').val(),h=$('#Beneficiario').val();(null==f||''==f)&&(f='0'),null==g&&(g='-1'),(null==h||''==h)&&(h='0'),$table.bootstrapTable({url:lang+'/gestion/logro/obtenerListado/'+f+'/'+g+'/'+h,pagination:!0,sidePagination:'client',pageSize:10,onLoadSuccess:()=>{},onLoadError:function(i){exception(i.status,i.responseJSON.error)}})}}function registro(){if($('#frm_registro').valid())if(iframeBody=document.querySelectorAll('.cke_wysiwyg_frame')[0].contentDocument.querySelector('body'),0<iframeBody.textContent.length){var c=$('#btnGuardar');c.button('loading');var f={id:$('#hIdLogro').val(),descripcion:iFrameBody.innerHTML},g=$('#FechaLogro').val().split('-');f.fechaLogro=new Date(g[0],+g[1]-1,g[2]),f.resumen=iFrameBody.textContent.substring(0,120).trim()+'...',f.estudioId=$('#hIdEstudio').val(),f.beneficiarioId=$('#hIdBeneficiario').val(),$.ajax({type:'POST',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:lang+'/gestion/logro/agregar',dataType:'json',data:f,success:function(h,i){'success'==i&&('-9'==h?$.smallBox({content:'<i> El registro ha fallado debido a que el nombre de logro ya existe en el sistema...</i>',timeout:4500,color:'alert'}):$.smallBox({content:'El registro ha sido actualizado satisfactoriamente...'}))},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){$('#hIdLogro').val(0),limpiarBusqueda(),irListado($index),listarRegistros(),c.button('reset')}})}else $.smallBox({content:'<i> El <strong> alcance del logro no actualizarse como vac\xEDo.</strong></i>',color:'#8a6d3b',iconSmall:'fa fa-warning fa-2x fadeInRight animated',timeout:3500})}function editar(c,f){var g={};g.id=c,$('#load_pace').show(),$.ajax({type:'GET',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:lang+'/gestion/logro/obtener',dataType:'json',data:g,success:function(h,i){'success'==i&&($('#hIdLogro').val(h.id),$('#hIdBeneficiario').val(f),$('#hIdEstudio').val(h.estudio.id),$('#FechaLogro').val(h.fechaLogro),iFrameBody.innerHTML=h.descripcion)},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){limpiarBusqueda(),irRegistro(),$('#load_pace').show()}})}function desactivar(c){$.SmartMessageBox({title:'<i class=\'fa fa-bullhorn\'></i> Notificaciones Prosemer',content:'<br/>\xBFQuieres activar o desactivar el registro?',buttons:'[No][Si]'},function(f){if('Si'===f){var g={};g.id=c,$('#load_pace').show(),$.ajax({type:'PUT',contentType:'application/x-www-form-urlencoded; charset=UTF-8',url:'/gestion/logro/desactivar',dataType:'json',data:g,success:function(h,i){'success'==i&&$.smallBox({content:'<i class=\'fa fa-child fa-2x\'></i> <i>Actualizaci\xF3n exitosa...!</i>'})},error:function(h){exception(h.status,h.responseJSON.error)},complete:function(){limpiarBusqueda(),listarRegistros()}})}else;})}function getBodyCKEditor(){iFrameBody=document.querySelectorAll('.cke_wysiwyg_frame')[0].contentDocument.querySelector('body')}function linkFormatter(c,f){return String('<a class="editable editable-click" href="#" onclick="javascript:editar('+f.id+','+f.beneficiario.id+')" title="Editar">'+f.resumen+'</a>',c)}function Opciones(c,f){return opciones=`<a href='#' onclick='javascript:desactivar(${f.id});' title='Actualizar status'><i class='glyphicon glyphicon-refresh'></i></a> &nbsp`,opciones}function isActived(c,f){return f.flagActivo?'<span class="label label-success">Activo</span>':'<span class="label label-danger">Inactivo</span>'}function validarRegistros(){$('#frm_registro').validate({errorClass:errorClass,errorElement:errorElement,highlight:function(c){$(c).parent().removeClass('state-success').addClass('state-error'),$(c).removeClass('valid')},unhighlight:function(c){$(c).parent().removeClass('state-error').addClass('state-success'),$(c).addClass('valid')},ignore:'.ignore',rules:{TituloLargo:{required:!0,maxlength:$('#TituloLargo').prop('maxlength')},TituloPrincipal:{required:!0,maxlength:$('#TituloPrincipal').prop('maxlength')},FechaLogro:{required:!0}},messages:{TituloLargo:{required:'El campo es obligatorio',maxlength:$.validator.format('Este campo debe de tener como m\xE1ximo {0} caracteres.')},TituloPrincipal:{required:'El campo es obligatorio',maxlength:$.validator.format('Este campo debe de tener como m\xE1ximo {0} caracteres.')},FechaLogro:{required:'Seleccione una fecha v\xE1lida'}},submitHandler:function(){registro()}})}function validarBusqueda(){$('#frm_busqueda').validate({ignore:'.ignore',errorClass:'my-error-class',validClass:'my-valid-class',rules:{Filtro:{required:!0},Tipo:{digits:!0}},messages:{Filtro:{required:'Debe seleccionar un tipo de formato'},Tipo:{digits:'Debe seleccionar un tipo'}},submitHandler:function(){}})}function limpiarBusqueda(){$('#txtFiltro').val(''),$('#Estado').val('-1')}